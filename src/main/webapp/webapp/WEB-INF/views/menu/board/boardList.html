<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 리스트</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/menu/board/boardList.css}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script th:inline="javascript">
    $(document).ready(function() {
      let pageFrm = $("#pageFrm");
      $(".paginate_button a").on("click", function(e) {
        e.preventDefault();
        let page = $(this).attr("href").split('=')[1]; // 페이지 번호 추출
        pageFrm.find("#page").val(page);
        pageFrm.submit();
      });
    });

    function detailBoard(user_id) {
      $.ajax({
        url: "detailBoard/" + user_id,
        type: "get",
        success: function (result) {
          boardHtml(result);
        }
      });
      $("#detailTitle").text("개시글 보기");
      $("#detailModal").modal("show");
    }

    function boardHtml(result) {
      let bodyHtml = `
        <div class="mb-5">
          <h6 class="fw-bold">제목</h6>
          <p>${result.title}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">닉네임</h6>
          <p>${result.nickname}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">작성 날짜</h6>
          <p>${result.created_at}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">내용</h6>
          <p>${result.content}</p>
        </div>
      `;
      $("#detailBody").html(bodyHtml);

      let footerHtml = `
        <button type="button" class="btn btn-danger" onclick="boardBlind(${result.writer_id})">
          ${result.is_blind === 0 ? 'Blind' : 'Blind 취소'}
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
      `;
      $("#modalFooter").html(footerHtml);
    }

    function boardBlind(user_id) {
      $.ajax({
        url: "boardBlind/" + user_id,
        type: "put",
        success: function (result) {
          if (result !== 0) {
            $("#modalTitle").text("성공");
            $("#modalBody").text("blind 되었습니다.");
          } else {
            $("#modalTitle").text("실패");
            $("#modalBody").text("blind 실패되었습니다.");
          }
        }
      });
      $("#detailModal").modal("hide");
      $("#checkModal").modal("show");
    }

    let sortOrderReport = true; // true: 오름차순, false: 내림차순
    let sortOrderLike = true; // true: 오름차순, false: 내림차순

    function sortTable(columnIndex, isReport) {
      const table = document.getElementById("boardTable");
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.rows);

      let sortOrder = isReport ? sortOrderReport : sortOrderLike;
      rows.sort((a, b) => {
        const aText = parseInt(a.cells[columnIndex].textContent, 10);
        const bText = parseInt(b.cells[columnIndex].textContent, 10);
        return sortOrder ? aText - bText : bText - aText;
      });

      sortOrder = !sortOrder;
      if (isReport) {
        sortOrderReport = sortOrder;
      } else {
        sortOrderLike = sortOrder;
      }

      rows.forEach(row => tbody.appendChild(row));

      // 화살표 업데이트
      if (isReport) {
        document.getElementById("sortArrowReport").innerHTML = sortOrderReport ? '&#9650;' : '&#9660;';
      } else {
        document.getElementById("sortArrowLike").innerHTML = sortOrderLike ? '&#9650;' : '&#9660;';
      }
    }
  </script>

</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="container">
  <div class="con">
    <a th:href="@{/menu/board/notice/add}">공지 추가</a>
    <table id="boardTable">
      <thead>
      <tr>
        <th>글번호</th>
        <th>아이디</th>
        <th>닉네임 or 관리자 이름</th>
        <th>제목(댓글수)</th>
        <th onclick="sortTable(4, true)">신고 <span id="sortArrowReport">&#9650;</span></th>
        <th onclick="sortTable(5, false)">좋아요 <span id="sortArrowLike">&#9650;</span></th>
        <th>블라인드 여부</th>
        <th>작성일시</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="board , iter : ${boards}" th:classappend="${board.is_notice == 1} ? 'highlight'">
        <td th:text="${totalCount - (iter.index + ((pageCre.criteria.current_page - 1) * pageCre.criteria.perPageNum))}"></td>
        <td>
          <a class="td_a_tag" th:if="${board.writer_id > 0}"
             th:href="@{/menu/user/userDetail(user_id=${board.writer_id})}"
             th:text="${board.writer_id}"></a>
          <a class="td_a_tag" th:if="${board.writer_id == 0}"
             th:href="@{/menu/manager/list(type='id',keyword=${board.admin_id})}"
             th:text="${board.admin_id}"></a>
        </td>
        <td th:text="${board.nickname != null ? board.nickname : board.name}">2</td>
        <td>
          <a class="td_a_tag" th:if="${board.writer_id > 0}"
             th:href="|javascript:detailBoard(${board.writer_id})|"
             th:text="${board.title} + '(' + ${board.report_count} + ')'">제목</a>
          <a class="td_a_tag" th:if="${board.writer_id == 0}"
             th:href="@{/menu/board/notice/detail(admin_writer_id=${board.admin_writer_id})}"
             th:text="${board.title}  + '(' + ${board.report_count} + ')'">제목</a>
        </td>
        <td th:text="${board.report_count}"></td>
        <td th:text="${board.heart_count}"></td>
        <td th:text="${board.is_blind != 1 ? 'X' : 'O'}"></td>
        <td th:text="${board.created_at}"></td>
      </tr>
      </tbody>
    </table>

    <div class="search-bar-container">
      <div class="search-bar">
        <form class="form-inline" th:action="@{/menu/board/boardList}" th:object="${criteria}" method="get">
          <select title="type" th:field="*{type}">
            <option value="id" th:selected="${criteria.type == 'writer_id'}">아이디</option>
            <option value="title" th:selected="${criteria.type == 'title'}">제목</option>
            <option value="name" th:selected="${criteria.type == 'nickname'}">닉네임</option>
            <option value="created_at" th:selected="${criteria.type == 'created_at'}">일자</option>
          </select>
          <input title="keyword" type="text" th:field="*{keyword}" placeholder="검색어를 입력하세요">
          <button type="submit">검색</button>
        </form>
      </div>
    </div>

  <!-- 페이지네이션 -->
  <ul class="pagination">
    <!-- 이전처리 -->
    <li class="paginate_button previous" th:if="${pageCre.prev}">
      <a class="page-link" th:href="@{/menu/board/boardList(page=${pageCre.startPage - 1})}">&laquo; Previous</a>
    </li>
    <!-- 페이지번호 처리 -->
    <li class="paginate_button" th:each="pageNum : ${#numbers.sequence(pageCre.startPage, pageCre.endPage)}"
        th:classappend="${pageCre.criteria.current_page == pageNum} ? 'active'">
      <a class="page-link" th:href="@{/menu/board/boardList(page=${pageNum})}" th:text="${pageNum}">1</a>
    </li>
    <!-- 다음처리 -->
    <li class="paginate_button next" th:if="${pageCre.next}">
      <a class="page-link" th:href="@{/menu/board/boardList(page=${pageCre.endPage + 1})}">Next &raquo;</a>
    </li>
  </ul>

  <form id="pageFrm" th:action="@{/menu/board/boardList}" method="get">
    <!-- 게시물 번호(idx) 추가 -->
    <input type="hidden" id="page" name="current_page" th:value="${pageCre.criteria.current_page}" />
    <input type="hidden" name="perPageNum" th:value="${pageCre.criteria.perPageNum}" />
    <input type="hidden" name="type" th:value="${pageCre.criteria.type}" />
    <input type="hidden" name="keyword" th:value="${pageCre.criteria.keyword}" />
  </form>
</div>
</div>

<div class="modal" id="detailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailTitle">Modal title</h5>
      </div>
      <div class="modal-body" id="detailBody">
      </div>
      <div class="modal-footer" id="modalFooter">
      </div>
    </div>
  </div>
</div>

<div class="modal" id="checkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Modal title</h5>
      </div>
      <div class="modal-body" id="modalBody">
        <p>Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="window.location.reload()">확인</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
