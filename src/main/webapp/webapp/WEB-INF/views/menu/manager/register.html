<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 등록</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/menu/manager/register.css}">



  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" >
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" ></script>
  <script>
    function nameValidation() {
      let name = $('#name').val();
      let pattern = /^[가-힣]{2,}$/;
      let nameValidation = $('#nameValidation');
      if (!pattern.test(name)) {
        nameValidation.removeClass('able');
        nameValidation.addClass('error');
        nameValidation.text('유효한 형태의 이름을 입력해주세요');
        return false;
      } else {
        nameValidation.removeClass('error');
        nameValidation.text('').addClass('able');
        return true;
      }
    }

    function idValidation() {
      let id = $('#id').val();
      let pattern = /^(?=.*[a-z])(?=.*\d)[a-z\d]{5,}$/;
      let idValidation = $('#idValidation');

      if (!pattern.test(id)) {
        idValidation.removeClass('able');
        idValidation.addClass('error');
        idValidation.text('아이디는 영문 소문자, 숫자를 포함해야합니다.');
        return false;
      } else {

        // Ajax로 아이디 중복 체크
        $.ajax({
          url: '/menu/manager/check-id',
          type: 'GET',
          data: {id: id},
          success: function(isDuplicate) {
            if (isDuplicate) {
              idValidation.removeClass('able');
              idValidation.addClass('error');
              idValidation.text('이미 사용 중인 아이디입니다.');
              return false;
            } else {
              idValidation.removeClass('error');
              idValidation.addClass('able');
              idValidation.text('사용 가능한 아이디입니다.');
              return true;
            }
          }
        });
      }
    }

        return idDuplicate(id).then(function(isDuplicate) {
          if (!isDuplicate) {
            idValidation.removeClass('able');
            idValidation.addClass('error');
            idValidation.text("이미 존재하는 아이디 입니다.");
            return false;
          } else {
            idValidation.removeClass('error');
            idValidation.text('사용 가능한 아이디입니다.').addClass('able');
            return true;
          }
        });
      }
    }

    // 아이디 중복 체크
    function idDuplicate(id) {
      return new Promise(function(resolve, reject) {
        $.ajax({
          url: "idDuplicate/" + id,
          type: "get",
          success: function(response) {
            resolve(response);
          },
          error: function(error) {
            reject(error);
          }
        });
      });
    }



    function passValidation() {
      let pass = $('#pass').val();
      let pattern = /^(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*])[a-z\d!@#$%^&*]{8,}$/;
      let passValidation = $('#passValidation');
      if (!pattern.test(pass)) {
        passValidation.removeClass('able');
        passValidation.addClass('error');
        passValidation.text('비밀번호는 영문 소문자, 숫자, 특수문자를 포함해야 합니다.');
        return false;
      } else {
        passValidation.removeClass('error');
        passValidation.text('사용 가능한 비밀번호입니다.').addClass('able');
        return true;
      }
    }

    function passConfirm() {
      let pass = $('#pass').val();
      let confirmPass = $('#confirm-password').val();
      let passConfirm = $('#passConfirm');
      if (pass !== confirmPass) {
        passConfirm.removeClass('able');
        passConfirm.addClass('error');
        passConfirm.text('비밀번호가 일치하지 않습니다.')
        return false;
      } else {
        passConfirm.removeClass('error');
        passConfirm.addClass('able');
        passConfirm.text('비밀번호가 일치합니다.');
        return true;
      }
    }


    $(document).ready(function(){
      $('#registerForm').submit(function(event){

    $(document).ready(function(){

      $('#managerModifyBTN').click(function(event){

        //하나라도 false면 이벤트 막음
        if (!passValidation() || !passConfirm() || !nameValidation() || !idValidation()) {
          event.preventDefault();
        }
      });
      if ($("#msg").val()) {
        $("#registerModal").modal("show");
      }
    });
  </script>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container">

  <form id="registerForm" th:action="@{/menu/manager/register_proc}" method="post">
    <!-- CSRF 토큰 -->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <div class="form-container">
      <h2>관리자 등록</h2>

      <!-- 알림 메시지 표시 -->
      <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

      <div class="form-group">
        <label for="name">이름</label>
        <input type="text" id="name" name="name" placeholder="이름을 입력하세요" required onkeyup="nameValidation()">
        <span id="nameValidation"></span>
      </div>
      <div class="form-group">
        <label for="id">아이디</label>
        <input type="text" id="id" name="id" placeholder="아이디를 입력하세요" required onkeyup="idValidation()">
        <span id="idValidation"></span>
      </div>
      <div class="form-group">
        <label for="pass">비밀번호</label>
        <input type="password" id="pass" name="pass" placeholder="비밀번호를 입력하세요" required onkeyup="passValidation()">
        <span id="passValidation"></span>
      </div>
      <div class="form-group">
        <label for="confirm-password">비밀번호 확인</label>
        <input type="password" id="confirm-password" placeholder="비밀번호를 다시 입력하세요" required onkeyup="passConfirm()">
        <span id="passConfirm"></span>
      </div>
      <div class="form-group">
        <label for="admin_level">등급</label>
        <select id="admin_level" name="admin_level">
          <option value="master">master</option>
          <option value="service_manager">service_manager</option>
        </select>
      </div>
      <div class="form-group">
        <button type="submit">등록</button>
      </div>
    </div>
  </form>
=======
<form th:action="@{/menu/manager/register_proc}" th:object="${admins}" method="post">
  <div class="form-container">
    <h2>관리자 등록</h2>
    <div class="form-group">
      <label for="name">이름</label>
      <input type="text" id="name" name="name" th:field="*{name}" placeholder="이름을 입력해주세요" required onkeyup="nameValidation()">
      <span id="nameValidation"></span>

    </div>
    <div class="form-group">
      <label for="id">아이디</label>
      <input type="text" id="id" name="id" th:field="*{id}" placeholder="아이디를 입력해주세요" required onkeyup="idValidation()">
      <span id="idValidation"></span>
    </div>
    <div class="form-group">
      <label for="pass">비밀번호</label>
      <input type="password" id="pass" name="pass" th:field="*{pass}" placeholder="비밀번호를 입력해주세요" required onkeyup="passValidation()">
      <span id="passValidation"></span>
    </div>
    <div class="form-group">
      <label for="confirm-password">비밀번호 확인</label>
      <input type="password" id="confirm-password" placeholder="비밀번호를 다시 입력해주세요" required onkeyup="passConfirm()">
      <span id="passConfirm"></span>
    </div>
    <div class="form-group">
      <label for="admin_level">등급</label>
      <select id="admin_level" name="admin_level" th:field="*{admin_level}">
        <option value="master">master</option>
        <option value="service_manager">service_manager</option>
      </select>
    </div>
    <div class="form-group">
      <button type="submit">등록</button>
    </div>
  </div>
</form>

</div>

<div class="modal" id="registerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title" th:text="${msgType}"></h5>
      </div>
      <div class="modal-body" id="modal-body">
        <p th:text="${msg}"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="window.location.href='/controller/menu/manager/list'">확인</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>