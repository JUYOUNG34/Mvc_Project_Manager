<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 리스트</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/menu/board/boardList.css}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script th:inline="javascript">
    $(document).ready(function() {
      loadPage(1); // 초기 로드 시 첫 페이지를 불러옵니다.

      $(document).on("click", ".paginate_button button", function(e) {
        e.preventDefault();
        let page = $(this).data("page"); // 페이지 번호 추출
        loadPage(page);
      });
      $("#searchForm").on("submit",function (e){
        e.preventDefault();
        loadPage(1);
      });

    });

    function loadPage(page) {
      let criteria = {
        current_page: page,
        perPageNum: 10, // 한 페이지에 보여줄 게시글 수
        type: $("#searchType").val(),
        keyword: $("#searchKeyword").val()
      };

      $.ajax({
        type: "POST",
        url: "/ajaxBoardList",
        contentType: "application/json",
        data: JSON.stringify(criteria),
        success: function(response) {
          updateBoardTable(response.boards);
          updatePagination(response.pageCre);
        }
      });
    }

    function updateBoardTable(boards) {
      let tbody = $("#boardTable tbody");
      tbody.empty();
      boards.forEach(function(board) {
        let row = `
                    <tr>
                        <td>${board.id}</td>
                        <td>${board.writer_id}</td>
                        <td>${board.nickname || board.name}</td>
                        <td>${board.title}</td>
                        <td>${board.report_count}</td>
                        <td>${board.heart_count}</td>
                        <td>${board.is_blind ? 'O' : 'X'}</td>
                        <td>${board.created_at}</td>
                    </tr>
                `;
        tbody.append(row);
      });
    }

    function updatePagination(pageCre) {
      let pagination = $(".pagination");
      pagination.empty();

      if (pageCre.prev) {
        pagination.append(`<li class="paginate_button previous"><button data-page="${pageCre.startPage - 1}">&laquo; Previous</button></li>`);
      }

      for (let i = pageCre.startPage; i <= pageCre.endPage; i++) {
        pagination.append(`<li class="paginate_button ${pageCre.criteria.current_page == i ? 'active' : ''}"><button data-page="${i}">${i}</button></li>`);
      }

      if (pageCre.next) {
        pagination.append(`<li class="paginate_button next"><button data-page="${pageCre.endPage + 1}">Next &raquo;</button></li>`);
      }
    }

    function detailBoard(user_id) {
      $.ajax({
        url: "detailBoard/" + user_id,
        type: "get",
        success: function (result) {
          boardHtml(result);
        }
      });
      $("#detailTitle").text("개시글 보기");
      $("#detailModal").modal("show");
    }

    function boardHtml(result) {
      let bodyHtml = `
        <div class="mb-5">
          <h6 class="fw-bold">제목</h6>
          <p>${result.title}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">닉네임</h6>
          <p>${result.nickname}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">작성 날짜</h6>
          <p>${result.created_at}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">내용</h6>
          <p>${result.content}</p>
        </div>
      `;
      $("#detailBody").html(bodyHtml);

      let footerHtml = `
        <button type="button" class="btn btn-danger" onclick="boardBlind(${result.writer_id})">
          ${result.is_blind === 0 ? 'Blind' : 'Blind 취소'}
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
      `;
      $("#modalFooter").html(footerHtml);
    }

    function boardBlind(user_id) {
      $.ajax({
        url: "boardBlind/" + user_id,
        type: "put",
        success: function (result) {
          if (result !== 0) {
            $("#modalTitle").text("성공");
            $("#modalBody").text("blind 되었습니다.");
          } else {
            $("#modalTitle").text("실패");
            $("#modalBody").text("blind 실패되었습니다.");
          }
        }
      });
      $("#detailModal").modal("hide");
      $("#checkModal").modal("show");
    }

  </script>

</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="container">
  <div class="con">
    <a th:href="@{/menu/board/notice/add}">공지 추가</a>
    <table id="boardTable">
      <thead>
      <tr>
        <th>글번호</th>
        <th>아이디</th>
        <th>닉네임 or 관리자 이름</th>
        <th>제목(댓글수)</th>
        <th>신고 </th>
        <th>좋아요 </th>
        <th>블라인드 여부</th>
        <th>작성일시</th>
      </tr>
      </thead>
      <tbody>

      </tbody>
    </table>

    <div class="search-bar-container">
      <div class="search-bar">
        <form class="form-inline" id="searchForm" th:action="@{/menu/board/boardList}" th:object="${criteria}" method="get">
          <select title="type" th:field="*{type}">
            <option value="id" th:selected="${criteria.type == 'writer_id'}">아이디</option>
            <option value="title" th:selected="${criteria.type == 'title'}">제목</option>
            <option value="name" th:selected="${criteria.type == 'nickname'}">닉네임</option>
            <option value="created_at" th:selected="${criteria.type == 'created_at'}">일자</option>
          </select>
          <input title="keyword" type="text" th:field="*{keyword}" placeholder="검색어를 입력하세요">
          <button type="submit">검색</button>
        </form>
      </div>
    </div>

    <!-- 페이지네이션 -->
    <ul class="pagination">

    </ul>

    <form id="pageFrm" th:action="@{/menu/board/boardList}" method="get">
      <!-- 게시물 번호(idx) 추가 -->
      <input type="hidden" id="page" name="current_page" th:value="${pageCre.criteria.current_page}" />
      <input type="hidden" name="perPageNum" th:value="${pageCre.criteria.perPageNum}" />
      <input type="hidden" name="type" th:value="${pageCre.criteria.type}" />
      <input type="hidden" name="keyword" th:value="${pageCre.criteria.keyword}" />
    </form>
  </div>
</div>

<div class="modal" id="detailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailTitle">Modal title</h5>
      </div>
      <div class="modal-body" id="detailBody">
      </div>
      <div class="modal-footer" id="modalFooter">
      </div>
    </div>
  </div>
</div>

<div class="modal" id="checkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Modal title</h5>
      </div>
      <div class="modal-body" id="modalBody">
        <p>Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="window.location.reload()">확인</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>