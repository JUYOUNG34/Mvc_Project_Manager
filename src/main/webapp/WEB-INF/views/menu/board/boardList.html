<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì ë¦¬ìŠ¤íŠ¸</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/sider.css}">
  <link rel="stylesheet" th:href="@{/css/menu/board/boardList.css}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script th:inline="javascript">


    let currentSortType = null;
    let currentOrder = 'desc'; // ì´ˆê¸° ì •ë ¬ì„ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

    $(document).ready(function() {
      loadPage(1, currentSortType, currentOrder); // ì´ˆê¸° ë¡œë“œ ì‹œ ì²« í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

      $(document).on("click", ".paginate_button button", function(e) {
        e.preventDefault();
        let page = $(this).data("page"); // í˜ì´ì§€ ë²ˆí˜¸ ì¶”ì¶œ
        loadPage(page, currentSortType, currentOrder);
      });

      $("#searchForm").on("submit", function(e) {
        e.preventDefault();
        loadPage(1, currentSortType, currentOrder);
      });

      $("th").on("click", function(e) {
        let sortType = $(this).data("sortType");
        if (sortType) {
          // ê°™ì€ sortTypeì„ í´ë¦­í•œ ê²½ìš° orderë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
          if (sortType === currentSortType) {
            currentOrder = (currentOrder === 'asc') ? 'desc' : 'asc';
          } else {
            // ë‹¤ë¥¸ sortTypeì„ í´ë¦­í•œ ê²½ìš° orderë¥¼ ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
            currentOrder = 'desc'; // ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          }
          currentSortType = sortType;
        } else {
          currentSortType = null;
          currentOrder = 'desc'; // ê¸°ë³¸ ì •ë ¬ì„ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        }
        loadPage(1, currentSortType, currentOrder);
        updateSortIcons(this, currentOrder); // í´ë¦­í•œ ìš”ì†Œì™€ ì •ë ¬ ìˆœì„œë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
      });

      // ì´ˆê¸° ìƒíƒœì—ì„œ ì •ë ¬ ì•„ì´ì½˜ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
      updateSortIcons(null, currentOrder);
    });

    function loadPage(page, sortType, order) {
      console.log(sortType);
      console.log(order);
      let criteria = {
        current_page: page,
        type: $("#searchType").val(),
        keyword: $("#searchKeyword").val(),
        sort: sortType ? sortType : null,
        order: sortType ? order : null
      };

      let queryString = $.param(criteria);

      $.ajax({
        type: "get",
        url: "ajaxBoards?" + queryString,
        success: function(response) {
          console.log(response.pageCre);
          updateBoardTable(response.boards, response.totalCount, response.pageCre);
          updatePagination(response.pageCre);
        }
      });
    }

    function updateSortIcons(clickedElement, order) {
      // $("th span").text(""); // ëª¨ë“  span ì´ˆê¸°í™”

      if (clickedElement) {
        $(clickedElement).find('span').text(order === 'asc' ? 'ğŸ”¼' : 'ğŸ”½');
      } else {
        // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ì˜ˆ: ì²« ë²ˆì§¸ th ìš”ì†Œì˜ ì •ë ¬ ì•„ì´ì½˜ ì„¤ì •)
        $("th[data-sort-type]:first").find('span').text('ğŸ”½');
      }
    }



    function updateBoardTable(boards, totalCount, pageCre) {
      let tbody = $("#boardTable tbody");
      tbody.empty();

      // boards ë°°ì—´ì„ is_notice ê°’ì— ë”°ë¼ ì •ë ¬í•©ë‹ˆë‹¤.
      boards.sort(function(a, b) {
        return b.is_notice - a.is_notice;
      });

      boards.forEach(function(board, index) {
        let rowClass = board.is_notice > 0 ? 'highlight' : '';
        let currentPage = pageCre.criteria.current_page;
        let perPageNum = pageCre.criteria.perPageNum;
        let rowNumber = totalCount - (index + ((currentPage - 1) * perPageNum));

        let row = '<tr class="' + rowClass + '">';
        row += '<td>' + rowNumber + '</td>';
        row += '<td>';
        if (board.writer_id > 0) {
          row += '<a class="td_a_tag" href="/controller/menu/user/userDetail?user_id=' + board.writer_id + '">' + board.writer_id + '</a>';
        } else {
          row += '<a class="td_a_tag" href="/controller/menu/manager/list?type=id&keyword=' + board.admin_id + '">' + board.admin_id + '</a>';
        }
        row += '</td>';
        row += '<td>' + (board.nickname || board.name) + '</td>';
        row += '<td>';
        if (board.writer_id > 0) {
          row += '<a class="td_a_tag" href="javascript:detailBoard(' + board.id + ')">' + board.title + ' (' + board.report_count + ')</a>';
        } else {
          row += '<a class="td_a_tag" href="/controller/menu/board/notice/detail?admin_writer_id=' + board.id + '">' + board.title + ' (' + board.report_count + ')</a>';
        }
        row += '</td>';
        row += '<td>' + board.report_count + '</td>';
        row += '<td>' + board.heart_count + '</td>';
        row += '<td>' + (board.is_blind ? 'O' : 'X') + '</td>';
        row += '<td>' + board.created_at + '</td>';
        row += '</tr>';

        tbody.append(row);
      });
    }



    function updatePagination(pageCre) {
      let pagination = $(".pagination");
      pagination.empty();

      if (pageCre && pageCre.prev) {
        pagination.append('<li class="paginate_button previous"><button data-page="' + (pageCre.startPage - 1) + '">&laquo; Previous</button></li>');
      }

      for (let i = pageCre.startPage; i <= pageCre.endPage; i++) {
        pagination.append('<li class="paginate_button ' + (pageCre.criteria.current_page == i ? 'active' : '') + '"><button data-page="' + i + '">' + i + '</button></li>');
      }

      if (pageCre.next) {
        pagination.append('<li class="paginate_button next"><button data-page="' + (pageCre.endPage + 1) + '">Next &raquo;</button></li>');
      }

    }

    function detailBoard(id) {
      $.ajax({
        url: "detailBoard/" + id,
        type: "get",
        success: function (result) {
          boardHtml(result);
        }
      });
      $("#detailTitle").text("ê°œì‹œê¸€ ë³´ê¸°");
      $("#detailModal").modal("show");
    }

    function boardHtml(result) {
      let bodyHtml = `
        <div class="mb-5">
          <h6 class="fw-bold">ì œëª©</h6>
          <p>${result.title}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">ë‹‰ë„¤ì„</h6>
          <p>${result.nickname}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">ì‘ì„± ë‚ ì§œ</h6>
          <p>${result.created_at}</p>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">ë‚´ìš©</h6>
          <p>${result.content}</p>
        </div>
      `;
      $("#detailBody").html(bodyHtml);

      let footerHtml = `
        <button type="button" class="btn btn-danger" onclick="boardBlind(${result.id})">
          ${result.is_blind === 0 ? 'Blind' : 'Blind ì·¨ì†Œ'}
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
      `;
      $("#modalFooter").html(footerHtml);
    }

    function boardBlind(id) {
      $.ajax({
        url: "blindProc/" + id,
        type: "put",
        // beforeSend:function (xhr){
        //   xhr.setRequestHeader(csrfHeader,csrfToken)
        // },
        success: function (result) {
          if (result !== 0) {
            $("#modalTitle").text("ì„±ê³µ");
            $("#modalBody").text("blind ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } else {
            $("#modalTitle").text("ì‹¤íŒ¨");
            $("#modalBody").text("blind ì‹¤íŒ¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
          }
        }
      });
      $("#detailModal").modal("hide");
      $("#checkModal").modal("show");
    }

  </script>

</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/sider :: sidebar}"></div>
<div class="container">
  <div class="con">
    <table id="boardTable">
      <thead>
      <tr>
        <th data-sort-type="id">ê¸€ë²ˆí˜¸<span>ğŸ”½</span></th>
        <th>ì•„ì´ë””</th>
        <th>ë‹‰ë„¤ì„ or ê´€ë¦¬ì ì´ë¦„</th>
        <th data-sort-type="comment_count">ì œëª©(ëŒ“ê¸€ìˆ˜)<span>ğŸ”½</span></th>
        <th data-sort-type="report_count">ì‹ ê³  <span>ğŸ”½</span></th>
        <th data-sort-type="heart_count">ì¢‹ì•„ìš” <span>ğŸ”½</span></th>
        <th data-sort-type="is_blind">ë¸”ë¼ì¸ë“œ<span>ğŸ”½</span></th>
        <th data-sort-type="created_at">ì‘ì„±ì¼ì‹œ<span>ğŸ”½</span></th>
      </tr>
      </thead>
      <tbody>

      </tbody>
    </table>

    <div class="search-bar-container">
      <div class="search-bar">
        <form class="form-inline" id="searchForm">
          <select title="type" id="searchType">
            <option value="id">ìœ ì €ì•„ì´ë””</option>
            <option value="title">ì œëª©</option>
            <option value="nickname">ë‹‰ë„¤ì„</option>
            <option value="created_at">ì¼ì</option>
          </select>
          <input title="keyword" type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          <button type="submit">ê²€ìƒ‰</button>
        </form>

      </div>
    </div>

    <ul class="pagination">

    </ul>

    <form id="pageFrm" th:action="@{/menu/board/boardList}" method="get">
      <!-- ê²Œì‹œë¬¼ ë²ˆí˜¸(idx) ì¶”ê°€ -->
      <input type="hidden" id="page" name="current_page" th:value="${pageCre.criteria.current_page}" />
      <input type="hidden" name="perPageNum" th:value="${pageCre.criteria.perPageNum}" />
      <input type="hidden" name="type" th:value="${pageCre.criteria.type}" />
      <input type="hidden" name="keyword" th:value="${pageCre.criteria.keyword}" />
    </form>
  </div>
</div>

<div class="modal" id="detailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailTitle">Modal title</h5>
      </div>
      <div class="modal-body" id="detailBody">
      </div>
      <div class="modal-footer" id="modalFooter">
      </div>
    </div>
  </div>
</div>

<div class="modal" id="checkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Modal title</h5>
      </div>
      <div class="modal-body" id="modalBody">
        <p>Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="window.location.reload()">í™•ì¸</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>