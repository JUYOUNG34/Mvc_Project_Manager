<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>사용자 차단 목록</title>
    <link rel="stylesheet" th:href="@{/css/menu/user/blacklist.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/sider.css}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" >

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" ></script>

</head>
<body style="background-color: #f4f4f4">
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/sider :: sidebar}"></div>
<div class="container">
    <h1>사용자 차단 목록</h1>

    <table class="blacklist-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>닉네임</th>
            <th>차단 날짜</th>
            <th>신고 사유</th>
            <th>차단 해제</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="blacklist : ${blacklists}">
            <td th:text="${blacklist.id}">사용자 ID</td>
            <td th:text="${blacklist.nickname}">닉네임</td>
            <td th:text="${#dates.format(blacklist.blocked_at, 'yyyy-MM-dd HH:mm:ss')}">차단 날짜</td>
            <td th:text="${blacklist.report_content}">신고 사유</td>
            <td>
                <button class="btn btn-unblock" th:data-user-id="${blacklist.id}">차단 해제</button>
                <form th:action="@{/menu/user/blacklist/unblock}" method="post">
                    <input type="hidden" name="id" th:value="${blacklist.id}" />
                    <button type="submit" class="btn btn-unblock">차단 해제</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="search-form">
        <form th:action="@{/menu/user/blacklist}" method="get">
            <select name="type">
                <option value="nickname" th:selected="${criteria.type == 'nickname'}">닉네임</option>
                <option value="userId" th:selected="${criteria.type == 'userId'}">사용자 ID</option>
            </select>
            <input type="text" name="keyword" th:value="${criteria.keyword}" placeholder="검색어 입력">
            <button type="submit">검색</button>
        </form>
    </div>
    <div th:if="${#lists.isEmpty(blacklists)}" class="no-blacklist">
        현재 차단된 사용자가 없습니다.
    </div>

    <!-- 페이징 버튼 -->
    <div class="pagination" th:if="${blacklists != null and blacklists.size() > 0}">
        <a th:if="${currentPage > 1}" th:href="@{/menu/user/blacklist(current_page=${currentPage - 1}, type=${criteria.type}, keyword=${criteria.keyword})}">이전</a>
        <span th:text="${currentPage} + ' / ' + ${totalPages}">1 / 10</span>
        <a th:if="${currentPage < totalPages}" th:href="@{/menu/user/blacklist(current_page=${currentPage + 1}, type=${criteria.type}, keyword=${criteria.keyword})}">다음</a>
    </div>
</div>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const unblockButtons = document.querySelectorAll('.btn-unblock');

        unblockButtons.forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');

                fetch('/menu/user/blacklist/unblock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': /*[[${_csrf.token}]]*/ ''
                    },
                    body: JSON.stringify({ userId: userId })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('사용자 차단 해제 완료');
                            location.reload();
                        } else {
                            alert('차단 해제 중 오류가 발생했습니다: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('차단 해제 중 네트워크 오류가 발생했습니다.');
                    });
            });
        });
    });

</script>
</body>
</html>